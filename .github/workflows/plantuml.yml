name: PlantUMLDiagrams

on:
  push:
    paths:
      - '**.puml'
    branches:
      - master
      - main

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Source 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          
      - name: Download PlantUML
        run: |
          wget -O plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.8/plantuml-1.2024.8.jar
          
      - name: Get changed UML files
        id: getfile
        run: |
          # Get list of changed .puml files (excluding theme/config files)
          CHANGED_FILES=$(git diff-tree -r --no-commit-id --name-only --diff-filter=d ${{ github.sha }} | grep '\.puml$' | grep -v -E '(theme|config)\.puml$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No .puml files to process"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "Found files to process:"
            echo "$CHANGED_FILES"
            # Convert to space-separated list
            FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "files=$FILES_LIST" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate SVG Diagrams
        if: steps.getfile.outputs.files != ''
        run: |
          for file in ${{ steps.getfile.outputs.files }}; do
            echo "Generating SVG for: $file"
            java -jar plantuml.jar -tsvg "$file"
          done
          
      - name: Generate PNG Diagrams
        if: steps.getfile.outputs.files != ''
        run: |
          for file in ${{ steps.getfile.outputs.files }}; do
            echo "Generating PNG for: $file"
            java -jar plantuml.jar -tpng "$file"
          done
          
      - name: Commit Generated Diagrams
        uses: stefanzweifel/git-auto-commit-action@v5
        with: 
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "Generate SVG and PNG images for PlantUML diagrams"
          file_pattern: "*.svg *.png"
