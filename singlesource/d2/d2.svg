<svg xmlns="http://www.w3.org/2000/svg" width="1280" height="800">
  <script src="https://unpkg.com/d2@latest/web/d2.min.js"></script>
  <script>
    function extractD2BlocksFromComments() {
      try {
        // Check if we can access parent document
        if (!window.parent || window.parent === window) {
          console.log('No parent window available');
          return [];
        }

        const parentDoc = window.parent.document;
        const walker = document.createTreeWalker(
          parentDoc.body,
          NodeFilter.SHOW_COMMENT,
          null,
          false
        );

        const d2Blocks = [];
        let node;
        
        while ((node = walker.nextNode())) {
          // Look for D2 code blocks in comments
          const match = node.nodeValue.match(/```d2\s*\n([\s\S]*?)\n```/);
          if (match) {
            d2Blocks.push({
              commentNode: node,
              d2Source: match[1].trim(),
              index: d2Blocks.length
            });
          }
        }

        console.log(`Found ${d2Blocks.length} D2 blocks`);
        return d2Blocks;
      } catch (error) {
        console.error('Error accessing parent document:', error);
        return [];
      }
    }

    function renderD2Diagrams() {
      const blocks = extractD2BlocksFromComments();
      
      if (blocks.length === 0) {
        console.log('No D2 blocks found');
        return;
      }

      // Clear the SVG and set up proper dimensions
      const svg = document.documentElement;
      svg.innerHTML = '';
      
      // Create a foreign object to hold HTML content
      const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
      foreignObject.setAttribute('x', '0');
      foreignObject.setAttribute('y', '0');
      foreignObject.setAttribute('width', '100%');
      foreignObject.setAttribute('height', '100%');
      
      const div = document.createElement('div');
      div.style.width = '100%';
      div.style.height = '100%';
      div.style.padding = '20px';
      div.style.fontFamily = 'Arial, sans-serif';
      div.style.backgroundColor = '#f9f9f9';
      
      foreignObject.appendChild(div);
      svg.appendChild(foreignObject);

      // Render each D2 block
      blocks.forEach(({ d2Source, index }) => {
        const container = document.createElement('div');
        container.id = `d2-container-${index}`;
        container.style.border = '1px solid #ddd';
        container.style.margin = '20px 0';
        container.style.padding = '10px';
        container.style.backgroundColor = 'white';
        container.style.borderRadius = '4px';
        
        // Add a title
        const title = document.createElement('h3');
        title.textContent = `D2 Diagram ${index + 1}`;
        title.style.margin = '0 0 10px 0';
        title.style.color = '#333';
        container.appendChild(title);
        
        // Add the diagram container
        const diagramDiv = document.createElement('div');
        diagramDiv.id = `d2-diagram-${index}`;
        diagramDiv.style.minHeight = '200px';
        container.appendChild(diagramDiv);
        
        div.appendChild(container);

        // Render the D2 diagram
        try {
          D2.render({
            src: d2Source,
            container: diagramDiv
          });
          console.log(`Rendered D2 diagram ${index + 1}`);
        } catch (error) {
          console.error(`Error rendering D2 diagram ${index + 1}:`, error);
          diagramDiv.innerHTML = `<p style="color: red;">Error rendering D2 diagram: ${error.message}</p>`;
        }
      });
    }

    function waitForD2AndRender() {
      if (typeof D2 !== 'undefined') {
        console.log('D2 library loaded, rendering diagrams...');
        renderD2Diagrams();
      } else {
        console.log('Waiting for D2 library...');
        setTimeout(waitForD2AndRender, 100);
      }
    }

    // Wait for DOM and then start the process
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, waiting for D2...');
      waitForD2AndRender();
    });

    // Fallback if DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // Document still loading, wait for DOMContentLoaded
    } else {
      // Document already loaded
      console.log('Document already loaded, starting immediately...');
      waitForD2AndRender();
    }
  </script>
</svg>
