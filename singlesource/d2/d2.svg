<svg xmlns="http://www.w3.org/2000/svg" width="1280" height="800">
  <script src="https://unpkg.com/d2@latest/web/d2.min.js" onload="console.log('D2 library loaded'); startD2Rendering();" onerror="console.error('Failed to load D2 library'); showMessage('Failed to load D2 library');"></script>
  <script>
    let renderAttempts = 0;
    let d2LoadStarted = false;

    function extractD2BlocksFromComments() {
      try {
        // Check if we can access parent document
        if (!window.parent || window.parent === window) {
          console.log('No parent window available');
          return [];
        }

        const parentDoc = window.parent.document;
        const walker = document.createTreeWalker(
          parentDoc.body,
          NodeFilter.SHOW_COMMENT,
          null,
          false
        );

        const d2Blocks = [];
        let node;
        
        while ((node = walker.nextNode())) {
          // Look for D2 code blocks in comments
          const match = node.nodeValue.match(/```d2\s*\n([\s\S]*?)\n```/);
          if (match) {
            d2Blocks.push({
              commentNode: node,
              d2Source: match[1].trim(),
              index: d2Blocks.length
            });
          }
        }

        console.log(`Found ${d2Blocks.length} D2 blocks`);
        return d2Blocks;
      } catch (error) {
        console.error('Error accessing parent document:', error);
        return [];
      }
    }

    function renderD2Diagrams() {
      const blocks = extractD2BlocksFromComments();
      
      if (blocks.length === 0) {
        console.log('No D2 blocks found');
        // Show a message that no D2 blocks were found
        showMessage('No D2 blocks found in parent document comments');
        return;
      }

      // Clear the SVG and set up proper dimensions
      const svg = document.documentElement;
      svg.innerHTML = '';
      
      // Create a foreign object to hold HTML content
      const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
      foreignObject.setAttribute('x', '0');
      foreignObject.setAttribute('y', '0');
      foreignObject.setAttribute('width', '100%');
      foreignObject.setAttribute('height', '100%');
      
      const div = document.createElement('div');
      div.style.width = '100%';
      div.style.height = '100%';
      div.style.padding = '20px';
      div.style.fontFamily = 'Arial, sans-serif';
      div.style.backgroundColor = '#f9f9f9';
      
      foreignObject.appendChild(div);
      svg.appendChild(foreignObject);

      // Render each D2 block
      blocks.forEach(({ d2Source, index }) => {
        const container = document.createElement('div');
        container.id = `d2-container-${index}`;
        container.style.border = '1px solid #ddd';
        container.style.margin = '20px 0';
        container.style.padding = '10px';
        container.style.backgroundColor = 'white';
        container.style.borderRadius = '4px';
        
        // Add a title
        const title = document.createElement('h3');
        title.textContent = `D2 Diagram ${index + 1}`;
        title.style.margin = '0 0 10px 0';
        title.style.color = '#333';
        container.appendChild(title);
        
        // Add the diagram container
        const diagramDiv = document.createElement('div');
        diagramDiv.id = `d2-diagram-${index}`;
        diagramDiv.style.minHeight = '200px';
        container.appendChild(diagramDiv);
        
        div.appendChild(container);

        // Render the D2 diagram
        try {
          D2.render({
            src: d2Source,
            container: diagramDiv
          });
          console.log(`Rendered D2 diagram ${index + 1}`);
        } catch (error) {
          console.error(`Error rendering D2 diagram ${index + 1}:`, error);
          diagramDiv.innerHTML = `<p style="color: red;">Error rendering D2 diagram: ${error.message}</p>`;
        }
      });
    }

    function showMessage(message) {
      const svg = document.documentElement;
      svg.innerHTML = '';
      
      const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
      foreignObject.setAttribute('x', '0');
      foreignObject.setAttribute('y', '0');
      foreignObject.setAttribute('width', '100%');
      foreignObject.setAttribute('height', '100%');
      
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.alignItems = 'center';
      div.style.justifyContent = 'center';
      div.style.height = '100%';
      div.style.fontFamily = 'Arial, sans-serif';
      div.style.fontSize = '18px';
      div.style.color = '#666';
      div.textContent = message;
      
      foreignObject.appendChild(div);
      svg.appendChild(foreignObject);
    }

    function startD2Rendering() {
      if (d2LoadStarted) return;
      d2LoadStarted = true;
      console.log('Starting D2 rendering...');
      renderD2Diagrams();
    }

    function waitForD2AndRender() {
      // This function is now only a fallback
      renderAttempts++;
      
      if (renderAttempts > 10) { // Reduced attempts since we have onload handler
        console.error('Fallback timeout waiting for D2 library');
        if (!d2LoadStarted) {
          showMessage('Timeout: D2 library failed to load');
        }
        return;
      }

      if (typeof D2 !== 'undefined' && !d2LoadStarted) {
        console.log('D2 library found via fallback, rendering diagrams...');
        startD2Rendering();
      } else if (!d2LoadStarted) {
        console.log(`Fallback check for D2 library... (attempt ${renderAttempts}/10)`);
        setTimeout(waitForD2AndRender, 200);
      }
    }

    // Wait for DOM and then start the fallback process
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, starting fallback timer...');
      setTimeout(waitForD2AndRender, 100); // Give onload handler a chance first
    });

    // Fallback if DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // Document still loading, wait for DOMContentLoaded
    } else {
      // Document already loaded
      console.log('Document already loaded, starting fallback immediately...');
      setTimeout(waitForD2AndRender, 100);
    }

    // Also handle script load event as final fallback
    window.addEventListener('load', () => {
      if (!d2LoadStarted) {
        console.log('Window loaded, trying final fallback...');
        setTimeout(() => {
          if (typeof D2 !== 'undefined' && !d2LoadStarted) {
            startD2Rendering();
          }
        }, 100);
      }
    });
  </script>
</svg>
