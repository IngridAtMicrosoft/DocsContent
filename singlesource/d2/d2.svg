<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0">
  <script src="https://unpkg.com/d2@latest/web/d2.min.js"></script>
  <script>
    function extractD2BlocksFromComments() {
      const walker = document.createTreeWalker(
        window.parent.document.body,
        NodeFilter.SHOW_COMMENT,
        null,
        false
      );

      const d2Blocks = [];

      let node;
      while ((node = walker.nextNode())) {
        const match = node.data.match(/```d2\s*\n([\s\S]*?)```/);
        if (match) {
          d2Blocks.push({ commentNode: node, d2Source: match[1].trim() });
        }
      }

      return d2Blocks;
    }

    function renderD2IntoParent() {
      const blocks = extractD2BlocksFromComments();

      blocks.forEach(({ commentNode, d2Source }) => {
        const container = window.parent.document.createElement('div');
        container.style.border = '1px solid #ccc';
        container.style.margin = '1em 0';
        container.style.overflow = 'auto';
        container.style.fontFamily = 'sans-serif';

        commentNode.parentNode.insertBefore(container, commentNode.nextSibling);

        D2.render({ src: d2Source, container });

        // Optional: remove the original comment node
        // commentNode.remove();
      });
    }

    function waitUntilReady() {
      if (typeof window.parent.D2 !== 'undefined') {
        renderD2IntoParent();
      } else if (typeof D2 !== 'undefined') {
        window.parent.D2 = D2;
        renderD2IntoParent();
      } else {
        setTimeout(waitUntilReady, 100);
      }
    }

    waitUntilReady();
  </script>
</svg>
